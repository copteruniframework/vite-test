function b(n){if(typeof n!="string"||!n.startsWith("P"))throw new Error("Invalid ISO-8601 duration");const u=/^P(?:(\d+)D)?(?:T(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?)?$/i,t=n.match(u);if(!t)throw new Error("Unsupported ISO-8601 duration format");const e=t[1]?Number(t[1]):0,a=t[2]?Number(t[2]):0,r=t[3]?Number(t[3]):0,o=t[4]?Number(t[4]):0;return(((e*24+a)*60+r)*60+o)*1e3}function i(n){return String(n).padStart(2,"0")}function N(n){const u=Math.max(0,Math.floor(n/1e3)),t=u%60,e=Math.floor(u/60),a=e%60,r=Math.floor(e/60),o=Math.floor(r/24),c=r%24;return{days:o,hours:c,minutes:a,seconds:t,totalHours:r}}function $(n,u="hms"){const{days:t,hours:e,minutes:a,seconds:r,totalHours:o}=N(n);return u==="auto"?t>0?`${t}d ${i(e)}:${i(a)}:${i(r)}`:`${i(o)}:${i(a)}:${i(r)}`:`${i(o)}:${i(a)}:${i(r)}`}function p(){function n(t,e){return t.getAttribute(`data-${e}`)??t.dataset[e]??null}document.querySelectorAll("[data-countdown]").forEach((t,e)=>{const a=n(t,"id")??"unknown",r=n(t,"mode");if(r==="visit"){let o=function(g){const l=d-g;if(l<=0){m&&clearTimeout(m),t.textContent=$(0,h),localStorage.removeItem(s);return}const D=Math.ceil(l/1e3),M=$(l+999,h);t.textContent=M;const S=l-(D-1)*1e3,y=Math.max(50,Math.min(1e3,S));m=window.setTimeout(()=>o(Date.now()),y)};const c=n(t,"duration"),h=n(t,"format")||"hms";if(!c)return;const w=b(c),s=`countdown::${a}::endAt`;let d=parseInt(localStorage.getItem(s)||"0",10);(!d||isNaN(d)||d<Date.now())&&(d=Date.now()+w,localStorage.setItem(s,String(d)));let m;o(Date.now());const f=()=>{document.hidden||(m&&clearTimeout(m),o(Date.now()))};document.addEventListener("visibilitychange",f)}else if(r==="deadline"){let o=function(m){const f=w-m;if(f<=0){s&&clearTimeout(s),t.textContent=$(0,h);return}const g=Math.ceil(f/1e3);t.textContent=$(f+999,h);const l=f-(g-1)*1e3,D=Math.max(50,Math.min(1e3,l));s=window.setTimeout(()=>o(Date.now()),D)};const c=n(t,"end-at"),h=n(t,"format")||"hms";if(!c){console.warn(`countdown[${e}] id=${a} fehlendes data-end-at`);return}const w=Date.parse(c);if(Number.isNaN(w)){console.warn(`countdown[${e}] id=${a} ungÃ¼ltiges data-end-at=${c}`),t.setAttribute("data-error","invalid-endAt");return}let s;o(Date.now());const d=()=>{document.hidden||(s&&clearTimeout(s),o(Date.now()))};document.addEventListener("visibilitychange",d)}else console.warn(`countdown[${e}] id=${a} unbekannter mode=${r}`)})}p();
